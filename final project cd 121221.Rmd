---
title: "Final Project cd 112921"
output: html_document
---
By: Cameron, Vikram, and Zoe

```{r}
#Load in Data and Libraries
library(ggplot2)
library(sjPlot)
library(tidyverse)
library(doBy)
library(maps)
library(stringr)
library(knitr)
library(data.table)
#install.packages("DT")
library(DT)
library(rgdal)
library(leaflet)
library(dplyr)
library(ggplot2)
library(broom)
library(usmap)
library(ggthemes)
library(ggdag)

amenities_data <- read.csv("amenities_scale.csv")

###Clean up variables and convert to what we need

#Census Divisions
amenities_data$cens_div <- factor(amenities_data$cens_div,
levels = c(1:9),
labels = c("New England", "Middle Atlantic", "East North Central", "West North Central", "South Atlantic", "East South Central", "West South Central", "Mountain", "Pacific"))


#States
amenities_data$state <- as.factor(amenities_data$state)

#Urban-Rural Code (varies from 0- Most Urban to 9- Most Rural)
```
The natural amenities scale data offers a measure of the geographical and physical qualities of a county that may make it desirable as a place to live.  First, we loaded the data we needed from a csv file and used several commands to clean up the data. 

Independent Variables

Census Divisions: The US Census Bureau divides the country into nine regions that are geographically contiguous. We labelled the census division variable and converted it to a factor variable from a numeric variable.

Rural-Urban Continuum Code: This measure, which ranges from 0 (most urban) to 9 (rural) captures the population density of a county by measuring if the county is in a metropolitan area and, if so, the population of the metropolitan area. 

Auxiliary Variables: We converted the state identifiers to a factor variable from a string variable, allowing for easier comparisons. Our other variables of interest were primarily numeric, so we did not alter them.

Dependent Variables

Natural Amenities Scale: The scale is constructed through six measures: warm winter, winter sun, temperate summer, low summer humidity, topographic variation, and water area. It is standardized around 0, with a standard deviation of 1 and ranges from -6.40 to 11.17 in this dataset.


First, we use the graphic capabilities of R to visualize some of the contributing factors to the natural amenities score.
```{r}

amenities_data = amenities_data %>% 
  mutate(fips = str_pad(as.character(fips), 5, pad="0"))

cens_div_data = map_with_data(amenities_data, values = "cens_div",na = NA)
cens_div_data = dplyr::select(cens_div_data, state, cens_div)

plot_usmap(
regions = c("states"),
exclude= c("AK","HI"),
data = cens_div_data,
values = "cens_div",
theme = theme_map(),
labels = TRUE,
label_color = "black"
) + labs(title = "Census Divisions")
```

```{r}
county_level_water_data = map_with_data(amenities_data, values = "water_area_log", na=NA)
county_level_water_data_WATER = dplyr::select(county_level_water_data, state, water_area_log)

plot_usmap(
regions = c("states"),
exclude= c("AK","HI"),
data = county_level_water_data_WATER,
values = "water_area_log",
theme = theme_map(),
labels = FALSE,
label_color = "grey"
) + 
  scale_fill_continuous(
    low = "white", high = "blue4", name = "Water Area Log Scale", label = scales::comma
  ) + theme(legend.position = "right")  + labs(title = "Water Area")

```

```{r}
county_level_urban_data = map_with_data(amenities_data, values = "rural_urban", na=NA)
county_level_urban_data_RURAL = dplyr::select(county_level_urban_data, fips, rural_urban)

plot_usmap(
regions = c("states"),
exclude= c("AK","HI"),
data = county_level_urban_data_RURAL,
values = "rural_urban",
theme = theme_map(),
labels = FALSE,
label_color = "grey"
) + 
  scale_fill_continuous(
    low = "mediumblue", high = "white", name = "Rural/Urban Scale", label = scales::comma
  ) + theme(legend.position = "right")  + labs(title = "Rural/Urban Score by County")
```

```{r}
state_level_data = map_with_data(amenities_data, values = "scale_seven", na=NA)
state_level_data_SCALE_SEVEN = dplyr::select(state_level_data, state, scale_seven)

plot_usmap(
regions = c("states"),
exclude= c("AK","HI"),
data = state_level_data_SCALE_SEVEN,
values = "scale_seven",
theme = theme_map(),
labels = FALSE,
label_color = "black"
) + 
  scale_fill_continuous(
    low = "white", high = "chartreuse4", name = "Amenities Scale", label = scales::comma
  ) + theme(legend.position = "right") + labs(title = "Amenities Score by State")
```

```{r}
county_level_data = map_with_data(amenities_data, values = "scale_seven",na = NA)
county_level_data_SCALE_SEVEN = dplyr::select(county_level_data, fips, scale_seven)

plot_usmap(
regions = c("states"),
exclude= c("AK","HI"),
data = county_level_data_SCALE_SEVEN,
values = "scale_seven",
theme = theme_map(),
labels = FALSE,
label_color = "grey",
color = "white"
) + 
  scale_fill_continuous(
    low = "white", high = "chartreuse4", name = "Amenities Scale", label = scales::comma
  ) + theme(legend.position = "right")  + labs(title = "Amenities Score by County")
```


```{r}
###Hypothesis 1

#Unadjusted Means for each region
division_means <- summaryBy(scale  ~ cens_div, data=amenities_data , FUN=c(mean), na.rm=TRUE)

#Graph
ggplot(data=division_means, aes(x=cens_div, y=scale.mean, fill=cens_div)) + geom_bar(stat = "identity") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + xlab("Census Division") + ylab("Scaled Mean") + ggtitle("Mean Amenities Score, by Census Division")
```

First, we constructed a set of mean scores for each census division and displayed the findings visually in a bar graph. We see that, on average, the highest scoring census divisions are Mountain and Pacific, and the lowest scoring census divisions are the East North Central and West North Central. These suggest that the Western United States is the region of the country with the highest natural amenities, while the Midwest has the lowest natural amenities. We explore these patterns further through a regression analyses
```{r}

#Model 1
model1 <- lm(scale ~ cens_div + rural_urban, data=amenities_data)
tab_model(model1, show.se=TRUE, digits = 3)

```
Model 1 examines the natural amenities scale as the dependent variable and examines the role of census division while adjsuting for urban density through the inclusion of the urban-rural scale as a control variable. New England is the omitted reference group. While controlling for urban density, four regions scored significantly lower than New England on the natural amenities scale: Middle Atlantic ($\beta$=-0.98; 95% CI=(-1.41,-0.55)), East North Central ($\beta$=-2.48; 95% CI=(-2.88,-2.10)), West North Central ($\beta$=-2.21; 95% CI=(-2.59,-1.83)), and East South Central ($\beta$=-0.76; 95% CI=(-1.15,-0.37)). Additionally, there were two regions that scored significantly better than New England while controlling for urban density: Mountain ($\beta$=2.49; 95% CI=(2.09,2.89)), and Pacific ($\beta$=4.13; 95% CI=(3.70,4.57)). These confirm the patterns suggested by the descriptive statistics above; the Western United States enjoys considerably higher natural amenities than the Midwest and more central regions of the country.

Additionally, we were interested in the association between rural-urban density and natural amenities score. Using a similar model, we examined that relationship while controlling for regional differences through the inclusion of the census division variable as a control. We found that a one-point increase on the rural-urban continuum code (range 0-9) was associated with a 0.037-point decrease in the natural amenities scale (95% CI=(-0.058,-0.017), P-Value<0.001). This suggests that more rural counties tended to have lower natural amenities scores. To be clear, this is not evidence of a causal relation- it is very plausible that natural amenities influence where people live, and in turn urban density, violating the exogeneity necessary to establish causality and raising a potential issue of reverse causality. These relationships are seen in the below Directed Acyclic Graph. However, as a descriptive observation, this association establishes that more rural counties tend to have lower natural amenities in the United States, even when adjusting for regional differences.

```{r}
theme_set(theme_dag())
dagify(amenity_score ~ urban_rural_score,
       amenity_score ~ census_division, labels = c("amenity_score" = "Amenities Score", 
                  "census_division" = "Census Division",
                  "urban_rural_score" = "Rural/Urban Score")) %>% 
  ggdag(text = FALSE, use_labels = "label", text_size = 3, node_size= 22, label_col = "blue") 
#model1 <- lm(scale ~ cens_div + rural_urban, data=amenities_data)
model1 <- lm(scale ~ cens_div, data=amenities_data)
coeffs <- summary(model1)$coefficients
means_from_lm <-coeffs[1] + c(0, coeffs[2:length(levels(amenities_data$cens_div))])

#Division means, obtained directy, do coincide with those obtained from regression coeffs
#(as they should) - we've checked for that already, no need to print them out once again
# division_means    

means_from_lm

#Zoe's attempt at controlling for ruran_urban
model2 <- lm(scale ~ cens_div + rural_urban, data=amenities_data)
coeffs <- summary(model2)$coefficients
means_from_lm2 <-coeffs[1] + c(0, coeffs[2:length(levels(amenities_data$cens_div))])

# Take a look at what division means controlled for urban_rural are
means_from_lm2

# Comparing means_from_lm & means_from_lm2 - no "exact" relation occurs
means_from_lm / means_from_lm2
means_from_lm2 / means_from_lm
means_from_lm - means_from_lm2

# One "strange" thing is that means_from_lm2 are all larger than means_from_lm2 - that shouldn't be happening. Let's do a check: weighted (by count) mean of means should equal to overall mean

# Note: length won't work with na.rm=TRUE
division_counts <- summaryBy(scale  ~ cens_div, data=amenities_data , FUN=length)$scale.length
division_counts
mean(amenities_data$scale)
sum(means_from_lm*division_counts) / sum(division_counts) # Coincide
sum(means_from_lm2*division_counts) / sum(division_counts) # Differs

# So, the overall mean, when computed from means_from_lm2 differs from the original,
# while it shouldn't. The reason for that is in lm2 there's a coefficient for 
# urban_rural (cur), so we need to "shift the mean back" by cur * mean(urban_rural)

summary(model2)$coefficients
cur = summary(model2)$coefficients["rural_urban",1]
cur * mean(amenities_data$rural_urban)
means_from_lm2 = means_from_lm2 + cur * mean(amenities_data$rural_urban)
sum(means_from_lm2*division_counts) / sum(division_counts) # Now works fine

# All in all, we need to make this amend for computing means straight away,
# that is, the formula for means from a linear model with control shoul look like 

means_from_lm2 <- coeffs[1] + 
      c(0, coeffs[2:length(levels(amenities_data$cens_div))]) +
      summary(model2)$coefficients["rural_urban",1] * mean(amenities_data$rural_urban)
sum(means_from_lm2*division_counts) / sum(division_counts) # Now works fine

# Now let's compare them once again
means_from_lm / means_from_lm2
means_from_lm2 / means_from_lm
means_from_lm - means_from_lm2

```